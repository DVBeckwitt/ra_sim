# Instrument-specific parameters used by the RA-SIM GUI and simulations.
instrument:
  detector:
    image_size: 3000
    monte_carlo_samples: 1000
    beam_stop_half_size: 40
    intensity_threshold: 1.0
    pixel_size_m: 1.0e-4
    vmax: 1000
    vmax_slider_max: 3000
  geometry_defaults:
    distance_m: 0.075
    rot1: 0.0
    rot2: 0.0
    poni1_m: 0.0
    poni2_m: 0.0
    wavelength_m: 1.0e-10
  beam:
    wavelength_angstrom: 1.54
    divergence_fwhm_deg: 0.05
    sigma_mosaic_fwhm_deg: 0.8
    gamma_mosaic_fwhm_deg: 0.7
    eta: 0.0
    bandwidth_percent: 0.7
    bandwidth_sigma_fraction: 5.0e-05
  sample_orientation:
    theta_initial_deg: 6.0
    cor_deg: 0.0
    chi_deg: 0.0
    psi_deg: 0.0
    psi_z_deg: 0.0
    zb: 0.0
    zs: 0.0
  debye_waller:
    x: 0.0
    y: 0.0
  occupancies:
    default: [1.0, 1.0, 1.0]
  hendricks_teller:
    default_p: [0.01, 0.99, 0.5]
    default_w: [50.0, 50.0, 0.0]
    phase_delta_expression: "2*pi*((2*h + k)/3)"
    phi_l_divisor: 1.0
    max_miller_index: 19
    include_rods: false
  output:
    write_excel: false
  fit:
    geometry:
      # Per-parameter bounds and sensitivity settings used during geometry fitting.
      #
      # Bounds support three modes:
      # - absolute: min/max are used as-is.
      # - relative: min/max are offsets added to the current parameter value.
      # - relative_min0: like relative, but the lower bound is clamped to >= 0.
      bounds:
        theta_initial: {mode: relative, min: -0.5, max: 0.5}
        zs: {mode: absolute, min: -2.0e-3, max: 2.0e-3}
        zb: {mode: absolute, min: -2.0e-3, max: 2.0e-3}
        chi: {mode: absolute, min: -1.0, max: 1.0}
        cor_angle: {mode: absolute, min: -2.0, max: 2.0}
        gamma: {mode: relative, min: -2.0, max: 2.0}
        Gamma: {mode: relative, min: -2.0, max: 2.0}
        psi_z: {mode: relative, min: -2.0, max: 2.0}
        corto_detector: {mode: relative_min0, min: -0.05, max: 0.05}
      # Per-parameter optimizer sensitivity (scales). Use 1.0 for defaults.
      x_scale:
        theta_initial: 1.0
        zs: 1.0
        zb: 1.0
        chi: 1.0
        cor_angle: 1.0
        gamma: 1.0
        Gamma: 1.0
        psi_z: 1.0
        corto_detector: 1.0
      # Solver settings for geometry least-squares.
      # - loss: robust residual model used by scipy.optimize.least_squares
      # - f_scale_px: soft transition scale in pixels for robust losses
      # - max_nfev: max objective evaluations per local solve
      # - restarts: random multi-start retries to escape local minima
      # - restart_jitter: fractional perturbation size per restart
      # - missing_pair_penalty_px: penalty when an HKL has measured peaks
      #   but no simulated points are matchable.
      # - weighted_matching: downweight large point-pair residuals.
      solver:
        loss: soft_l1
        f_scale_px: 8.0
        max_nfev: 140
        restarts: 4
        restart_jitter: 0.15
        missing_pair_penalty_px: 20.0
        weighted_matching: true
      # Automatic background peak association for geometry fitting.
      auto_match:
        search_radius_px: 18.0
        local_max_size_px: 5
        smooth_sigma_px: 3.0
        min_prominence_sigma: 2.0
        min_match_prominence_sigma: 2.5
        k_neighbors: 8
        max_candidate_peaks: 1200
        fit_iterations: 3
        min_matches: 12
        max_display_markers: 120
      single_ray:
        enabled: true
      # Set to false to avoid numba JIT during fitting (useful if numba
      # compilation fails on your Python build).
      use_numba: true
